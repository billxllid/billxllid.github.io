---
title: Ansible笔记
categories: '04_学习笔记'
tags:
  - linux
  - ansible
date: 2018-07-05 00:36:14
---

**概述：** ansible基于python实现，是一款强大的多主机管理工具。通过他可以实现批量的任务执行，大大简化了大量主机场景下的维护难度。

 <!-- more -->

{% asset_path 20180705-ansible笔记 %}

# Ansible笔记

参考自[国内最专业的Ansible中文官方学习手册](http://ansible-tran.readthedocs.io/en/latest/docs/intro_inventory.html)。

@[TOC]

## TODO

一些有趣的用法:
[Ansible 小手册系列 二十（经常遇到的问题）](https://www.jianshu.com/p/7354ae0235c6).

补全模块中的内容:
补全playbook中的内容:
[Introduction To Ad-Hoc Commands &mdash; 国内最专业的Ansible中文官方学习手册](http://ansible-tran.readthedocs.io/en/latest/docs/intro_adhoc.html#managing-packages)

## 指令用法

典型指令:

``` shell
ansible <host-pattern> [options]

# example:
ansible example -m service -a "name=httpd state=restarted"
```

### 主机对象(host-pattern)

改变host-pattern则可以改变要操作的主机对象,有一定的语法格式:

``` ini
# 所有主机
all
*

# 单个IP或者分组
127.0.0.1
dns.example.com
gruop01

# 多个IP(支持通配符)
192.168.1.*

# 多个主机或者判定条件,使用:分割
127.0.0.1:127.0.0.2
foo.example.com:foo.excample.com

# 条件范围(可以多个同时作为条件)
group01:!group02  # 从group01中排除group02中的组员
host:!centos
group01:!group02  # group01与02共同的主机(交集)

# 组中某几个主机
group01[2]
group01[1-5]

# 正则表达式(~开头即可,有点像awk的if判断)
~(web|db).*\.example\.com
```

`--limit`有助于排除一部分条目(黑名单)

``` ini
ansible-playbook site.yml --limit datacenter2

# 如果你想从文件读取hosts,文件名以@为前缀即可.从Ansible 1.2开始支持该功能:
ansible-playbook site.yml --limit @retry_hosts.txt
```

### 选项(options)

比较常用到的:

命令:

- `-i INVENTORY`: 指定inventory文件
- `-m MODULE_NAME`: 指定模块(下面会说明,默认是command)
- `-a MODULE_ARGS`: 模块属性
- `-f FORKS, --forks=FORKS`: 设置并发线程,默认5个

输出:

- `-o`: 一行输出,将结果格式化为一行输出
- `-v`: verbose,`-vvv`可现实更多,`-vvvv`开启debug模式

用户:

- `-k, --ask-pass`: 交互式输入`-u USER`指定user的密码
  - `--private-key=PRIVATE_KEY_FILE`: 私钥方式登录
- `-u REMOTE_USER`: 指定登录的用户

权限:

a) sudo方式

- `-s, --sudo`: *建议使用`become`,sudo方式运行指令
- `-U SUDO_USER`: 指定对应的sudo用户身份,默认root
  - `--sudo-user=SUDO_USER`
- `--ask-sudo-pass`: 输入sudo的密码

例子:

``` shell
ansible 192.168.56.101 \
-m shell -a 'whoami && pwd' \
-u billx -k \
-s -U root  --ask-sudo-pass

输出:
192.168.56.101 | SUCCESS | rc=0 >>
root
```

b) su方式

- `-S, --su`: *建议使用`become`,su切换用户
- `-R SU_USER`: 指定对应的su切换的用户身份
  - `--su-user=SU_USER`
- `--ask-su-pass`: 输入su的密码

例子:

``` shell
ansible 192.168.56.101 \
-m shell -a 'whoami && pwd' \
-u billx -k \
-S -R root  --ask-su-pass

输出:
192.168.56.101 | SUCCESS | rc=0 >>
root
/home/billx
```

**:warning: 注意：** 这里默认的su模式非`su -`也就是没有带环境变量的

c) become方式(推荐)

- `-b, --become`: 更高级的用户权限切换
  - `--become-method=BECOME_METHOD`: 默认sudo,支持[ sudo | su | pbrun | pfexec | doas | dzdo | ksu | runas | pmrun | enable | machinectl ]
  - `--become-user=BECOME_USER`: 默认root
- `-K, --ask-become-pass`: become对应的用户密码

例子:

``` shell
ansible -i hosts all \
-m shell -a 'whoami && pwd' \
-u billx -k \
-b \
--become-method=su \
--become-user=root \
-K

# 输出:
centos01 | SUCCESS | rc=0 >>
root
/home/billx

centos02 | SUCCESS | rc=0 >>
root
/home/billx
```

### 模块(modle)

使用`-m`时需要制定不同的模块,也就是简单的Ad_hoc模式

**a)** shell

``` shell
ansible raleigh -m shell -a 'echo $TERM'
```

**:warning: 注意：** 注意 shell 引号的规则. 比如在上面的例子中,如果使用双引号”echo $TERM”,会求出TERM变量在当前系统的值,而我们实际希望的是把这个命令传递 到其它机器执行.

**b)** copy

..

## Inventory文件

Ansible可以通过inventory文件同时操作多台主机，默认路径为`/etc/ansible/hosts`（但安装时并未创建），可通过`-i INVENTORY`参数指定文件。

除默认文件外,还可以同时使用多个inventory文件，并且还可以从动态源,或云上拉取inventory配置信息。

### 基本

``` ini
# 单台(可以是ip也可以是主机名)
127.0.0.1
mail.example.com

# 非默认22端口
127.0.0.1:33
example_01 ansible_ssh_host=127.0.0.1 ansible_ssh_port=33

```

### 分组/合并

``` ini
# 分组
[example]
foo.example.com
bar.example.com

# 多类似主机简写
[example]
host[01:10].example.com
host[1:10].example.com  # 与01写法意义相同
host[a:f].example.com

# 把一个组作为另一个组的子成员
[foo]
host1
host2

[bar]
host2
host3

[example:children]
foo
bar
```

### 变量

``` ini
# 主机变量
[foo]
host1 http_port=80 maxRequestsPerChild=808
host2 http_port=303 maxRequestsPerChild=909

# 组变量
[foo]
host1
host2

[foo:vars]
ntp_server=ntp.atlanta.example.com
proxy=proxy.atlanta.example.com
```

### 参数说明

``` ini
# 将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.
ansible_ssh_host

# ssh端口号.如果不是默认的端口号,通过此变量设置.
ansible_ssh_port

# 默认的 ssh 用户名
ansible_ssh_user

# ssh 密码(这种方式并不安全,我们强烈建议使用 --ask-pass 或 SSH 密钥)
ansible_ssh_pass

# sudo 密码(这种方式并不安全,我们强烈建议使用 --ask-sudo-pass)
ansible_sudo_pass

# sudo 命令路径(适用于1.8及以上版本)
ansible_sudo_exe (new in version 1.8)

# 与主机的连接类型.比如:local, ssh 或者 paramiko. Ansible
# 1.2 以前默认使用 paramiko.1.2 以后默认使用 'smart','smart'
# 方式会根据是否支持 ControlPersist, 来判断'ssh' 方式是否可行.
ansible_connection

# ssh 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况.
ansible_ssh_private_key_file

# 目标系统的shell类型.默认情况下,命令的执行使用 'sh' 语法,可设置为 'csh' 或 'fish'.
ansible_shell_type

# 目标主机的 python 路径.适用于的情况: 系统中有多个 Python,
# 或者命令路径不是"/usr/bin/python",比如  \*BSD, 或者
# /usr/bin/python 不是 2.X 版本的 Python.我们不使用
# "/usr/bin/env" 机制,因为这要求远程用户的路径设置正确,且要求
# "python" 可执行程序名不可为 python以外的名字(实际有可能名为
# python26).
ansible_python_interpreter

*python换成ruby也可以改变ruby的解释器
```

举个例子:

``` ini
some_host         ansible_ssh_port=2222     ansible_ssh_user=manager
aws_host          ansible_ssh_private_key_file=/home/example/.ssh/aws.pem
freebsd_host      ansible_python_interpreter=/usr/local/bin/python
ruby_module_host  ansible_ruby_interpreter=/usr/bin/ruby.1.9.3

[foo]
some_host ansible_ssh_host=127.0.0.1
[foo:vars]
ansible_ssh_user=test
```

### 加密

使用`ansible-vault`工具实现对inventory文件的加密操作

``` shell
# 加密文件:
ansible-vault encrypt hosts  # 这里hosts是文件名
# 输出:
New Vault password:
Confirm New Vault password:
Encryption successful

cat hosts
# 输出:
$ANSIBLE_VAULT;1.1;AES256
343366383330643563303137386461..


# 使用加密文件:
ansible -i hosts --ask-vault-pass all -m ping -u billx -k
# 输出:
SSH password:
Vault password:
centos01 | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
centos02 | SUCCESS => {
    "changed": false,
    "ping": "pong"
}


# 解密文件:
ansible-vault decrypt hosts
# 输出:  
Vault password:
Decryption successful

cat hosts
# 输出:
[test]
centos0[1:2] ansible_ssh_host=192.168.56.101

[test:vars]
ansible_ssh_port = 22
```

## playbook脚本

### demo

ansible_hosts文件,文件名`hosts`.

``` ini
[test]
centos0[1:2] ansible_ssh_host=192.168.56.101

[test:vars]
ansible_ssh_port = 22
```

playbook文件,文件名`test.yml`

``` yaml
---
- hosts: test
  remote_user: billx
  become: yes
  become_user: root
  become_method: sudo
  tasks:
    - name: hello
      shell: for i in "PermitEmptyPasswords" "PermitRootLogin" "MaxAuthTries" "Ciphers" "MACs" "ListenAddress";do egrep -v '^#|^$' /etc/ssh/sshd_config | egrep -i $i; done;
```

开始执行:

``` shell
ansible-playbook test.yml -i hosts -k -K -v
```

更多参考:

[Intro to Playbooks &mdash; Ansible Documentation](https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html)

## 声明

**版权：** 2018-now，:cn:，zangjiaao\<zangjiaao@yahoo.com>

由家浩创作并维护的`zangjiaao's blog`博客所有文章除特别声明外，均采用"署名-非商业性使用-相同方式共享4.0(CC BY-NC-SA 4.0)[国际许可证](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)"。

本文首发于[zangjiaao's blog](https://blog.zangjiaao.cn/)博客，转载请注明出处。
