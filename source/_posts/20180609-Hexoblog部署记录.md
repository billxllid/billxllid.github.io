---
title: Hexoblog部署记录
date: 2018-06-09 20:33:50
categories: 02_环境搭建
---

**概述：** 记录我是如何搭建这个"快速、简洁且高效的博客框架"的Hexo博客的..

 <!-- more -->

# Hexo博客部署

@[TOC]

## 环境搭建

### 依赖

- 安装[Git](https://git-scm.com/)
- 安装[Node.js](https://nodejs.org/en/)

可参考官方[文档](https://hexo.io/zh-cn/docs/#%E5%AE%89%E8%A3%85-Hexo)。

### 安装

只需要使用npm安装hexo，默认带`server`了：

``` bash
npm install -g hexo-cli
```

### 初始化

刚才安装的那些只是hexo的部署环境以及管理命令，以下才是真正的“建站”，初始化/创建站点文件。

``` powershell
cd hexo_blog
hexo init
```

> **:book: 说明：**[官方文档](https://hexo.io/zh-cn/docs/setup.html)中还有一步`npm install`，实际在`init`时候就做好了。

### 更新

更新hexo，只需npm即可。

``` bash
cd hexo_blog
hexo update
```

## 修改主题

### NexT

>**:warning: 注意：** 如果需要将整个项目托管到Github，可以暂时忽略本节内容。

简介请移步官网，[传送门](https://github.com/theme-next/hexo-theme-next)。

- **安装:**

```
cd hexo_blog
git clone https://github.com/theme-next/hexo-theme-next themes/next
```

- **更新:**

```
cd themes/next
git pull
```

- **启用:** 修改 **`站点`** 的`_config.yml`文件

```
theme: next
```

## 建立Github项目

为了防止辛苦写出来的文章不翼而飞，同时也想用GitHub把源码维护起来，因此将源文件托管到Github。

参考[Tips for Hexo configuration](https://www.yuthon.com/2016/04/11/Tips-for-Hexo-configuration/)大神文章。

### 将源文件托管到Github

- **fork Next**

{% asset_path 20180609-Hexoblog部署记录 %}
{% asset_img fork一个项目.png fork一个项目 %}

点右上角的fork即可。

- **初始化blog为git项目**

``` bash
cd hexo_blog
git init
```

- **创建分支（本地），并切换**

``` bash
git checkout -b source
# 查看是不是进入了source分支
git branch
   master
  *source
# 如果创建错了，可以删除
git branch -D bad_branch
# 也可以重命名
git branch -m bad_branch good_branch
```

- **将之前fork的next添加到submodule**

``` bash
# 下面的操作会吧themes/next路径添加到submodules中
# 并且识别如果目录不存在会自动clone
pwd
  hexo_blog/
git submodule add git@github.com:billxllid/next.git  themes/next
# 添加错了可以删除，不过方法需要自行查找，并不难
# 创建自己的next分支，名字随便设置
cd themes/next
git checkout -b zangjiaao
# 然后可以随便修改主题配置什么的
# 上传分支
git add .
git commit -m "change configs"
# 刚才设置的分支是什么这就是什么
git push origin zangjiaao
```

- **上传到分支（远端）**

``` bash
pwd
    hexo_blog/
git add .
git commit -m "Initial"
git remote add origin
# 添加远端仓库地址
git@github.com:billxllid/blog.zangjiaao.cn.git
# push分支到远端
git push origin source
```

### 更新项目

- **更新next**

``` bash
# 新环境才需要init
git submodule init
# 正常update即可
git submodule update
```

直接更新master分支，而后merge到自己的分支上。

``` bash
pwd
  themes/next
git branch
  *master
  zangjiaao
git remote add upstream https://github.com/theme-next/hexo-theme-next.git
git remote -v
  origin  https://github.com/billxllid/next.git (fetch)
  origin  https://github.com/billxllid/next.git (push)
  upstream        https://github.com/theme-next/hexo-theme-next.git (fetch)
  upstream        https://github.com/theme-next/hexo-theme-next.git (push)
# 查看master有没有更新
git fetch upstream
# 可以直接更新远端
git pull upstream master
# 或者先merge到本地，再push到远端
git merge upstream/master
git push
```

> **:bulb: 技巧：** 可以到自己next项目的自己的分支创建pull来对比一下upstream，看哪里有修改。

## 配置&说明

### 配置文件说明

- `_config.yml` 站点主要配置文件。
- `package.json` hexo所使用的组件信息。
- `scaffolds/` 模板目录。
- `source/` 资源目录，包含原始文章`.md`以及解析后文章（保存在`public`目录下）。

### 命令行说明

- `hexo init` 初始化站点文件
- `hexo new [layout] <title>` 按照模板`layout`创建post
- `hexo (g)enerate` 生成静态文件
  - `-d` 创建完后部署（上传到git）
  - `-w` 检查文件变动
- `hexo server` 启动服务器
  - `-p` 指定端口给
  - `-s` 只使用静态文件
  - `-l` 记录日志
- `hexo deploy` 部署（上传到git）
  - `-g` 部署前生成静态文件
- `hexo clean` 清除缓存文件 (db.json) 和已生成的静态文件 (public)

> **:bulb: 提醒：** 每次修改 站点 `_config.yml` 文件后由于hexo的缓存问题需要刷新。一种办法是`hexo g`重新生成，好处是不用重启Server；另一种方法是`hexo clean & hexo server`，这种我认为更彻底，不过比较麻烦就是。

更多详见 [指令](https://hexo.io/zh-cn/docs/commands.html) 。

### 基本配置

简单修改（标题、语言、时区）

```
# Site
title: zangjiaao's blog
subtitle: 滴水穿石...
description: 纸上得来终觉浅...
keywords:
author: jiahao
language: zh-CN
timezone: Asia/Shanghai
```

更多详见 [官方文档](https://hexo.io/zh-cn/docs/configuration.html) 。

### 添加分类 & 标签

- **创建:**

```
# 分类
hexo new page categories

# 标签
hexo new page tags
```

- **编辑:** 在`index.md`中添加以下内容

```
# 分类
---
title: categories
date: 2018-05-06 00:57:48
type: "categories"
---

# 标签
---
title: tags
date: 2018-05-06 00:57:48
type: "tags"
---
```

### 添加头像

- **配置:** 在 **`主题`** 的`_config.yml`中查找`avatar`并编辑为下面的内容，随后上传头像文件至 **`站点`** 的`uploads`并重命名为`avatar.gif`。

```
avatar: /uploads/avatar.gif
```

> **:book: 说明：** 放主题对应目录也可以，参考主题配置文件注释中的说明。

### 添加显示当前进度

- **配置:** 在 **`主题`** 的`_config.yml`中查找`scrollpercent`并将参数改为`true`即可。

### 配置首页只显示简介

默认情况首页显示的是文章全文，为了查看方便可以为首页配置预览，ThanksTo[这篇文章](https://www.jianshu.com/p/393d067dba8d)。

- **修改主题配置文件：**

```
auto_excerpt:
  enable: true
  length: 150
```

但是默认会把数据格式成无格式的字符串，很是丑陋。配置文件上其实说明了，需要在文章中用下面的注释分割你想要显示的部分。

```
希望在首页看到的部分..

<!-- more -->

不希望在首页看到的部分..
```

### 添加资源目录

资源文件主要用来存放例如图片、CSS、JS等文件。如果数量不多，可以放在`source/images`文件夹中，通过`![](/images/image.jpg)`引用它们。

但是这样资源文件时间一长还是会比较难管理，所以需要开启“文章资源文件夹”功能。

- **修改站点配置：**

``` yaml
# _config.yml
post_asset_folder: true
```

开启后，通过`hexo new`创建文章时，会自动创建一个同名目录用于存放资源文件。

但是使用markdown语法直接引用站点首页无法显示的，所以需要使用下面的语法。

``` html
{% asset_path xxx %}
{% asset_img xxx [title] %}
<!-- 用于引用js -->
{% asset_link xxx [title] %}
```

具体可参考官方：[资源文件夹](https://hexo.io/zh-cn/docs/asset-folders.html)。

### 压缩静态资源

由于hexo在生成静态文件时会产生很多空行，使用[chenzhutian/hexo-all-minifier](https://github.com/chenzhutian/hexo-all-minifier)插件来压缩这些文件。

- **安装：**

```
npm install hexo-all-minifier --save
```

对于mac用户还需要安装下面的依赖：

```
brew install libtool automake autoconf nasm
```

- **配置站点配置文件：**

```
all_minifier: true
```

并且该插件还支持配置需要压缩的其他内容，可以在官方文档中查看。

### 压缩静态资源-使用gulp

偶遇一大佬使用这个办法进行压缩，感觉很给力的样子。由于我没有试过，这里分享一下链接：[Tips for Hexo configuration](https://www.yuthon.com/2016/04/11/Tips-for-Hexo-configuration/)。

### 部署到GitHub

保能够正常push项目后，按照下面方法进行部署。

- **修改站点配置文件：**

``` yaml
deploy:
  type: git
  repo: https://github.com/billxllid/billxllid.github.io.git
  branch: master
  message: Update
  name: billxllid
  email: zangjiaao@yahoo.com
  ignore_hidden: true
```

- **生成静态文件：** 建议先`hexo clean`清理一下旧数据。

``` bash
hexo clean
hexo generate
```

> **:book: 说明：** 有时候修改文件名、删除分类或者标签，页面上的计数、列表会异常（计数加1，分类没有删除改名之前的文章标题），这时候使用`clean`就能解决了。

- **部署到Github：**

``` bash
hexo deploy
```

过一会就能够访问了（github需要一段时间处理）。

如果有自己域名的同学，可以将域名加一条`CNAME`到你得gitio上面，然后在项目设置里配置一下。

{% asset_path '20180609-Hexoblog部署记录' %}
{% asset_img  'Github自定义io域名.png' Github自定义io域名 %}

## 功能拓展

### （推荐）markdown-it-plus 插件

这个插件支持`TOC`和`emoji`特性，而且不需要为了追求与`Next`的兼容性去修改配置。同时还兼容`sub`、`sup`也就是角标、`Katex`公式、`ins`下划线和删除线渲染，可见强大，因此推荐。[了解更多](https://www.npmjs.com/package/hexo-renderer-markdown-it-plus)。

- **安装:** 在站点目录`hexo_blog`执行

```
npm un hexo-renderer-marked --save
npm i hexo-renderer-markdown-it-plus --save
```

- **配置:** 修改 **`站点`** 的`config.yml`文件

```
markdown_it_plus:
     highlight: true
     html: true
     xhtmlOut: true
     breaks: true
     langPrefix:
     linkify: true
     typographer:
     quotes: “”‘’
     pre_class: highlight
```

### （不推荐）emoji支持

- **切换渲染:** 因为`hexo-renderer-marked`不支持（实际是支持的[crimx/hexo-filter-github-emojis](https://github.com/crimx/hexo-filter-github-emojis)太丑了），固改用`markdown-it`渲染

```
npm un hexo-renderer-marked --save
npm i hexo-renderer-markdown-it --save
```

- **安装:**

```
npm install markdown-it-emoji --save
```

- **配置:** 注意这里修改的是 **`站点`** 的`_config.yml`

```
markdown:
  render:
    html: true
    xhtmlOut: false
    breaks: true
    linkify: true
    typographer: true
    quotes: '“”‘’'
  plugins:
    - markdown-it-abbr
    - markdown-it-footnote
    - markdown-it-ins
    - markdown-it-sub
    - markdown-it-sup
    - markdown-it-emoji   #用emoji插件
  anchors:
    level: 1
    collisionSuffix: 'v'
    permalink: true
    permalinkClass: header-anchor
    permalinkSymbol: ''   #设置'¶'会导致页面中显示出错
```

更多详见 [Hexo添加emoji | Very9s](http://very9s.net/post/hexo-support-emoji/) 。

### （不推荐）hexo-TOC

插件[bubkoo/hexo-toc](https://github.com/bubkoo/hexo-toc)与`Next`主题有极大的冲突，安装之后将导致**侧边目录失效！！**不推荐安装。

若迫不得已需要安装也可依据下面内容调整。

**弥补方法:** 通过将`${blog_root}/node_modules/hexo-toc/lib/filter.js`中的`28行~31行`改为下面内容。

```
$title.attr('id', id);
// $title.children('a').remove();
// $title.html( '<span id="' + id + '">' + $title.html() + '</span>' );
// $title.removeAttr('id');
```

随后还需要替换'markdown-it'，请见上一章节相关安装方法，并修改`hexo-toc`的配置为：

```
toc:
  maxdepth: 3
  class: toc
  slugify: transliteration
  decodeEntities: false
  anchor:
    position: after
    symbol: ''    #主要删除了symbol
    style: header-anchor
```

更多详见 [Content&#39;s link show &#39;undefine&#39; · Issue #11 · YenYuHsuan/hexo-theme-beantech](https://github.com/YenYuHsuan/hexo-theme-beantech/issues/11) 中`@fawks96`的回答。

### emoji速查表

:joy:

[Emoji cheat sheet for GitHub, Basecamp and other services](https://www.webpagefx.com/tools/emoji-cheat-sheet/)

### 404页面

直接创建`source/404.html`文件即可，我直接把谷歌文字的错误页面拔了下来改了改，感觉挺有“windows”错误页面的风格，页面源码如下：

``` html
ayout: false
title: "404"
---
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Oops!</title>
        <style type="text/css">
                * {
                        padding: 0;
                        margin: 0;
                }

                html {
                        overflow-y: scroll;
                }

                body {
                        background: #fff;
                        font-family: '微软雅黑';
                        color: #333;
                        font-size: 16px;
                }

                img {
                        border: 0;
                }

                .error {
                        padding: 24px 48px;
                }

                .face {
                        font-size: 100px;
                        font-weight: normal;
                        line-height: 120px;
                        margin-bottom: 12px;
                }

                h1 {
                        font-size: 32px;
                        line-height: 48px;
                }

                .error .content {
                        padding-top: 10px
                }

                .error .info {
                        margin-bottom: 12px;
                }

                .error .info .title {
                        margin-bottom: 3px;
                }

                .error .info .title h3 {
                        color: #000;
                        font-weight: 700;
                        font-size: 16px;
                }

                .error .info .text {
                        line-height: 24px;
                }

                .copyright {
                        padding: 12px 48px;
                        color: #999;
                }

                .copyright a {
                        color: #000;
                        text-decoration: none;
                }
        </style>
</head>

<body>
        <div class="error">
                <p class="face">:(</p>
                <h1>找不到指定文件...</h1>
                <div class="title">
                        <h3>&nbsp;</h3>
                </div>
                <div class="text">
                        <p>错误代码：404.
                        </p>
                </div>
```

### 搜索（本地）

- **安装:** 站点根目录下执行

```
npm install hexo-generator-searchdb --save
```

- **配置1:** 站点`_config.yml`中修改

```
search:
  path: search.xml
  field: post
  format: html
  limit: 10000
```

- **配置2:** 主题`_config.yml`中修改

```
# Local search
# Dependencies: https://github.com/flashlab/hexo-generator-search
local_search:
  enable: true
  # if auto, trigger search by changing input
  # if manual, trigger search by pressing enter key or search button
  trigger: auto
  # show top n results per article, show all results by setting to -1
  top_n_per_article: 1
```

### 搜索（algolia）

本地解析`server.xml`出现问题，导致本地搜索功能失效，没办法只好采用线上搜索模式。

配置方法可参考[theme-next/hexo-theme-next](https://github.com/theme-next/hexo-theme-next/blob/master/docs/ALGOLIA-SEARCH.md)。

- **注册algolia账号：**

访问[Algolia](https://www.algolia.com/)官网注册一个账号。

- **获取ID：**

其中`Application ID`和`Search-only API key`需要在下图中获取。

{% asset_img algoliaAPI.png algoliaAPI %}

`indexName`需要自己设置：

{% asset_img algoliaIndexName.png algoliaIndexName %}

然后站点配置文件需要以下参数：

``` yaml
algolia:
  applicationID: 'Application ID'
  apiKey: 'Search-only API key'
  indexName: 'indexName'
  chunkSize: 5000
```

- **生成数据：**

对，没错，手动生成...不过晚了可以写个脚本之类的，其实无非就是每次需要执行两条命令而已。

``` bash
# 其中的API Key就是上面的
export HEXO_ALGOLIA_INDEXING_KEY=Search-Only API key
hexo clean
hexo algolia
```

- **安装next插件：**

``` bash
cd themes/next
git clone https://github.com/theme-next/theme-next-algolia-instant-search source/lib/algolia-instant-search
```

- **配置CDN:** 编辑主题的配置文件。

``` yaml
vendors:
  ...
  # Internal version: 1
  # https://www.algolia.com
  algolia_instant_js: https://cdn.jsdelivr.net/npm/instantsearch.js@2.4.1/dist/instantsearch.js
  algolia_instant_css: https://cdn.jsdelivr.net/npm/instantsearch.js@2.4.1/dist/instantsearch.min.css
  ...
```

- **打开功能：** 最后一步是在主题配置文件中开启。

``` bash
# Algolia Search
algolia_search:
  enable: true
  hits:
    per_page: 10
  labels:
    input_placeholder: Search for Posts
    hits_empty: "We didn't find any results for the search: ${query}"
    hits_stats: "${hits} results found in ${time} ms"
```

### 创建文章时自动打开VSCode

请参考该文章[new 时自动打开 VSCode](https://leaferx.online/2018/03/17/hexo-auto-open-vscode/)。

### 添加评论功能

经过测试，多说，来必达都不够友好，发现其他博客上使用“gitment”以及“Hypercomments”作为评论解决方案，试了以下非常给力。官网在[这里](https://www.hypercomments.com/)，登录使用谷歌，所以自备梯子。

- **注册，并获取获取ID**

注册这里就不细说了，获取ID需要到：`settiong - Widget - code`的`widget_id`值。

- **编辑主题配置文件**

``` yaml
# Hypercomments
hypercomments_id: xxxxxx
```

还有另一种方式，不过没有用过，但是好多人都在用：[Valine](https://valine.js.org/quickstart/)，以后可以对比一下。

### 添加页面载入进度条

Next主题原生支持，修改主题配置开启即可。

``` yaml
pace: true
# Themes list:
#pace-theme-big-counter
#pace-theme-bounce
#pace-theme-barber-shop
#pace-theme-center-atom
#pace-theme-center-circle
#pace-theme-center-radar
#pace-theme-center-simple
#pace-theme-corner-indicator
#pace-theme-fill-left
#pace-theme-flash
#pace-theme-loading-bar
#pace-theme-mac-osx
#pace-theme-minimal
# For example
# pace_theme: pace-theme-center-simple
pace_theme: pace-theme-flash
```

更详细说明可参考：[theme-next/theme-next-pace](https://github.com/theme-next/theme-next-pace)。

### 其他功能

- 插入音乐

[Hexo+Next主题优化](https://zhuanlan.zhihu.com/p/30836436)。

[APlayer](https://aplayer.js.org/#/zh-Hans/)

[Hexo博客中插入音乐](https://www.jianshu.com/p/6e41e3191963)

## 声明

**版权：** 2018-now，:cn:，zangjiaao\<zangjiaao@yahoo.com>

由家浩创作并维护的`zangjiaao's blog`博客所有文章除特别声明外，均采用"署名-非商业性使用-相同方式共享4.0(CC BY-NC-SA 4.0)[国际许可证](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)"。

本文首发于[zangjiaao's blog](https://blog.zangjiaao.cn/)博客，转载请注明出处。